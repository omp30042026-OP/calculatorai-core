import { describe, it, expect } from "vitest";
import { applyEventWithStore } from "../src/store-engine";
import { createMemoryStore } from "./_helpers/memory-store"; // adjust to your helper

describe("Feature 18: Hard RBAC gate for finalize events", () => {
  it("BLOCKS APPROVE if actor has no approver/admin role", async () => {
    const store = createMemoryStore(); // must expose .db + ensureEnterpriseTables via engine
    const decision_id = "d1";

    // create decision by first event (non-finalize)
    await applyEventWithStore(store as any, {
      decision_id,
      event: { type: "SET_FIELDS", actor_id: "u1", actor_type: "human", fields: { x: 1 } } as any,
      internal_bypass_enterprise_gates: false,
    } as any);

    // try APPROVE
    const r = await applyEventWithStore(store as any, {
      decision_id,
      event: { type: "APPROVE", actor_id: "u1", actor_type: "human" } as any,
      internal_bypass_enterprise_gates: false,
    } as any);

    expect(r.ok).toBe(false);
    if (!r.ok) {
      expect(r.violations.some(v => v.code === "RBAC_ROLE_REQUIRED")).toBe(true);
    }
  });

  it("ALLOWS APPROVE when actor has approver role", async () => {
    const store = createMemoryStore();
    const decision_id = "d2";

    await applyEventWithStore(store as any, {
      decision_id,
      event: { type: "SET_FIELDS", actor_id: "u2", actor_type: "human", fields: { x: 1 } } as any,
      internal_bypass_enterprise_gates: false,
    } as any);

    // grant role
    if (store.grantRole) {
      await store.grantRole(decision_id, "u2", "approver");
    } else {
      // fallback: direct db insert if your helper store exposes db
      const db: any = (store as any).db;
      db.prepare(`INSERT OR IGNORE INTO decision_roles(decision_id, actor_id, role, created_at) VALUES (?, ?, ?, ?)`)
        .run(decision_id, "u2", "approver", new Date().toISOString());
    }

    const r = await applyEventWithStore(store as any, {
      decision_id,
      event: { type: "APPROVE", actor_id: "u2", actor_type: "human" } as any,
      internal_bypass_enterprise_gates: false,
    } as any);

    expect(r.ok).toBe(true);
  });

  it("BYPASSES gate when internal_bypass_enterprise_gates=true", async () => {
    const store = createMemoryStore();
    const decision_id = "d3";

    await applyEventWithStore(store as any, {
      decision_id,
      event: { type: "SET_FIELDS", actor_id: "u3", actor_type: "human", fields: { x: 1 } } as any,
      internal_bypass_enterprise_gates: true,
    } as any);

    const r = await applyEventWithStore(store as any, {
      decision_id,
      event: { type: "APPROVE", actor_id: "u3", actor_type: "human" } as any,
      internal_bypass_enterprise_gates: true,
    } as any);

    expect(r.ok).toBe(true);
  });
});
